<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Recovery Scanner</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body class="bg-gradient-to-br from-blue-100 to-white min-h-screen text-slate-800 p-4">
  <div class="max-w-2xl mx-auto space-y-4">
    <div class="flex items-center justify-between">
      <h1 class="text-2xl font-bold">Recovery Scanner</h1>
      <a href="{{ url_for('routes.user_settings') }}" class="text-sm text-blue-700 hover:underline">Back to Settings</a>
    </div>

    <div id="status" class="hidden text-sm text-center px-4 py-2 rounded-xl"></div>
    <div id="last-status" class="text-xs text-slate-600 hidden">Last status: -</div>

    <div class="bg-white/70 backdrop-blur-md border border-white/30 p-5 rounded-xl space-y-3 shadow">
      <p class="text-sm text-slate-700">Stay on this page while recovering. Scans post directly to your session without opening new tabs.</p>
      <div class="space-y-2">
        <button id="start-camera" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl py-2 px-4 shadow w-full sm:w-auto">Start Camera</button>
        <div id="reader" class="mt-2 border border-dashed border-slate-300 rounded-xl w-full" style="min-height: 280px;"></div>
      </div>

      <div class="space-y-2">
        <label class="block text-sm font-semibold">Paste QR URL (fallback)</label>
        <textarea id="qr-text" class="w-full px-4 py-2 rounded-xl bg-white/70 border border-white/40 shadow-inner" rows="3" placeholder="https://www.tokatap.com/scan/master/123"></textarea>
        <button id="submit-text" class="bg-amber-600 hover:bg-amber-700 text-white font-semibold rounded-xl py-2 px-4 shadow w-full sm:w-auto">Submit</button>
      </div>
    </div>

    {% if session.get('recovery_batch_id') %}
    <div class="bg-white/70 backdrop-blur-md border border-white/30 p-5 rounded-xl space-y-3 shadow">
      <div class="flex items-center justify-between">
        <div>
          <h2 class="text-lg font-semibold">Attach Machine to Recovered Batch</h2>
          <p class="text-sm text-slate-600">Batch ID: <strong>{{ session.get('recovery_batch_id') }}</strong></p>
        </div>
        <span class="text-xs font-semibold text-green-700 bg-green-100 px-2 py-1 rounded-full">Recovery</span>
      </div>
      <p class="text-sm text-slate-700">Attach machine details to this recovered batch. No new QR codes will be generated while in Recovery Mode.</p>
      <form method="POST" action="{{ url_for('routes.recovery_attach_machine') }}" class="space-y-3">
        <div>
          <label class="block text-sm font-semibold mb-1">Machine Name</label>
          <input type="text" name="name" class="w-full px-4 py-2 rounded-xl bg-white/70 border border-white/40 shadow-inner" placeholder="e.g., Main Unit" required>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-semibold mb-1">Type/Location</label>
            <input type="text" name="type" class="w-full px-4 py-2 rounded-xl bg-white/70 border border-white/40 shadow-inner" placeholder="e.g., Factory Floor">
          </div>
          <div>
            <label class="block text-sm font-semibold mb-1">Number of Heads</label>
            <input type="number" name="num_heads" min="1" value="{{ session.get('recovery_num_heads', 8) }}" class="w-full px-4 py-2 rounded-xl bg-white/70 border border-white/40 shadow-inner">
          </div>
          <div>
            <label class="block text-sm font-semibold mb-1">Needles per Head</label>
            <input type="number" name="needles_per_head" min="1" value="15" class="w-full px-4 py-2 rounded-xl bg-white/70 border border-white/40 shadow-inner">
          </div>
        </div>
        <div class="text-right">
          <button type="submit" class="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold rounded-xl py-2 px-4 shadow">Attach Machine</button>
        </div>
      </form>
    </div>
    {% else %}
    <div class="bg-white/70 backdrop-blur-md border border-white/30 p-4 rounded-xl shadow text-sm text-slate-700">
      Scan the Master QR first to set a recovery batch before attaching a machine.
    </div>
    {% endif %}
  </div>

  <script>
    const statusBox = document.getElementById('status');
    const readerElem = document.getElementById('reader');
    const startButton = document.getElementById('start-camera');
    const submitTextButton = document.getElementById('submit-text');
    const qrTextarea = document.getElementById('qr-text');

    let html5QrCode = null;
    let isScanning = false;

    const lastStatusLine = document.getElementById('last-status');

    function updateLastStatus(status) {
      lastStatusLine.textContent = `Last status: ${status}`;
      lastStatusLine.classList.remove('hidden');
    }

    function showStatus(message, type) {
      statusBox.textContent = message;
      statusBox.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800');
      if (type === 'success') {
        statusBox.classList.add('bg-green-100', 'text-green-800');
      } else {
        statusBox.classList.add('bg-red-100', 'text-red-800');
      }
    }

    async function sendToBackend(qr_text) {
      try {
        const resp = await fetch("/recovery/ingest", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Accept": "application/json"
          },
          body: JSON.stringify({ qr_text })
        });

        const ct = resp.headers.get("content-type") || "";
        let payload = null;
        if (ct.includes("application/json")) {
          payload = await resp.json();
        } else {
          const txt = await resp.text();
          updateLastStatus(resp.status);
          throw new Error(`Non-JSON response (${resp.status}). ${txt.slice(0, 200)}`);
        }

        updateLastStatus(resp.status);

        if (resp.status === 401 && payload.login_url) {
          window.location = payload.login_url;
          return;
        }

        if (!payload.ok) {
          let message = payload.error || 'Unable to process scan.';
          if (payload.path) {
            message += ` (${payload.path})`;
          }
          showStatus(message, 'error');
          return;
        }

        if (payload.type === 'need_map') {
          window.location = payload.redirect;
          return;
        }

        showStatus(payload.message || 'Scan processed.', 'success');
      } catch (err) {
        updateLastStatus('error');
        showStatus(err.message || 'Network error while sending scan.', 'error');
      }
    }

    function startScanner() {
      if (isScanning) return;
      if (!html5QrCode) {
        html5QrCode = new Html5Qrcode('reader');
      }
      html5QrCode.start({ facingMode: 'environment' }, { fps: 10, qrbox: 250 },
        (decodedText) => {
          isScanning = true;
          showStatus('QR detected, sending to server...', 'success');
          sendToBackend(decodedText);
          html5QrCode.stop().then(() => { isScanning = false; }).catch(() => { isScanning = false; });
        },
        (errorMessage) => {
          // ignore scan errors to keep scanning
        }
      ).catch(() => {
        showStatus('Unable to access camera. Use the paste fallback.', 'error');
      });
    }

    startButton.addEventListener('click', startScanner);
    submitTextButton.addEventListener('click', function () {
      const text = qrTextarea.value.trim();
      if (!text) {
        showStatus('Please paste a QR URL first.', 'error');
        return;
      }
      showStatus('Submitting QR text...', 'success');
      sendToBackend(text);
    });
  </script>
</body>
</html>
