<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Needle Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-100 to-white min-h-screen px-4 py-6">

  <!-- Logo -->
  <div class="text-center mb-4">
    <img src="{{ url_for('static', filename='img/logo.png') }}" class="h-12 sm:h-14 mx-auto" alt="Logo">
  </div>

  <!-- Header -->
  <div class="text-center sm:text-left mb-6 px-2">
    <h2 class="text-lg sm:text-xl font-semibold text-slate-800">
      Batch {{ sub_tag.batch.id }} – Sub QR: {{ sub_tag.tag_type }}
    </h2>
  </div>

  <!-- Glass Form Card -->
  <div class="max-w-3xl mx-auto bg-white/30 backdrop-blur-xl p-6 sm:p-8 rounded-2xl shadow-lg">

    <form method="POST">
      
      <!-- Select Needle -->
      <h3 class="text-base sm:text-lg font-semibold text-slate-800 mb-3">Select Needle Number</h3>
      <div class="grid grid-cols-5 gap-4 sm:gap-6 mb-6">
        {% for i in range(1, 16) %}
          {% set log = last_change_dict.get(i) %}
          {% set is_stale = log and (now - log.timestamp).days > 10 %}
          <div class="flex flex-col items-center text-center cursor-pointer rounded-full p-2 w-16 h-32 transition 
                      border-2 
                      {% if is_stale %}bg-yellow-100 border-yellow-400 text-yellow-900
                      {% else %}bg-white/70 border-slate-400 text-slate-800
                      {% endif %}" 
               data-id="{{ i }}" onclick="selectNeedle(this)">
            <div class="font-bold text-lg">{{ i }}</div>
            {% if log %}
              <div class="text-xs mt-1 leading-tight">{{ log.timestamp.strftime('%d') }}<br>{{ log.timestamp.strftime('%b') }}</div>
            {% endif %}
          </div>
        {% endfor %}
      </div>
      <input type="hidden" name="needle_number" id="needle_number" required>

      <!-- Select Type -->
      <h3 class="text-base sm:text-lg font-semibold text-slate-800 mb-3">Select Needle Type</h3>
      <div class="flex justify-center gap-6 mb-6">
        <button type="button" class="type-btn w-20 h-10 bg-white/60 border-2 border-slate-500 rounded-xl font-bold text-slate-700"
                data-type="11" onclick="selectType(this)">11</button>
        <button type="button" class="type-btn w-20 h-10 bg-white/60 border-2 border-slate-500 rounded-xl font-bold text-slate-700"
                data-type="12" onclick="selectType(this)">12</button>
      </div>
      <input type="hidden" name="needle_type" id="needle_type" required>

      <button type="submit"
              class="w-full bg-slate-800 hover:bg-slate-900 text-white font-semibold py-2 rounded-xl shadow transition">
        Log Needle Change
      </button>
    </form>

    <!-- Log Display -->
    <div class="mt-10">
      <h3 class="text-base sm:text-lg font-semibold text-slate-800 mb-3">Latest Changes:</h3>
      <ul class="space-y-2">
        {% for needle in range(1, 16) %}
          <li class="p-3 rounded-lg text-sm shadow-sm
                     {% if last_change_dict.get(needle) %}
                       {% set log = last_change_dict.get(needle) %}
                       {% set days_old = (now - log.timestamp).days %}
                       {% if days_old > 10 %}
                         bg-yellow-100 text-yellow-900
                       {% else %}
                         bg-white/50 text-slate-800
                       {% endif %}
                     {% else %}
                       bg-white/40 text-slate-500
                     {% endif %}">
            {% if last_change_dict.get(needle) %}
              Needle {{ needle }} (Type {{ log.needle_type }}) – {{ log.timestamp.strftime('%d %b %Y') }}
            {% else %}
              Needle {{ needle }} – No data available
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    </div>
  </div>

  <!-- Script -->
  <script>
    function selectNeedle(elem) {
      document.querySelectorAll('.needle-selected').forEach(e => e.classList.remove('needle-selected'));
      elem.classList.add('ring-4', 'ring-green-400', 'needle-selected');
      document.getElementById('needle_number').value = elem.dataset.id;
    }

    function selectType(elem) {
      document.querySelectorAll('.type-btn').forEach(e => e.classList.remove('bg-green-500', 'text-white', 'border-green-600'));
      elem.classList.add('bg-green-500', 'text-white', 'border-green-600');
      document.getElementById('needle_type').value = elem.dataset.type;
    }
  </script>

</body>
</html>
