<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>User Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    function toggleMachineDashboard() {
      const machinesBox = document.getElementById("machines-box");
      const batchesBox = document.getElementById("batches-box");
      const machineDashboard = document.getElementById("machine-dashboard");

      machinesBox.classList.toggle("col-span-2");
      batchesBox.classList.toggle("hidden");
      machineDashboard.classList.toggle("hidden");
    }

    function closeMachineDashboard() {
      toggleMachineDashboard();
    }

    function toggleBatch(id) {
      const box = document.getElementById(`batch-${id}`);
      const arrow = document.getElementById(`chevron-${id}`);
      box.classList.toggle("hidden");
      arrow.classList.toggle("rotate-180");
    }
  </script>
</head>
<body class="bg-gradient-to-br from-blue-100 to-white min-h-screen text-gray-800 p-4">

  <div class="max-w-2xl mx-auto mb-4 flex justify-center">
    <img src="{{ url_for('static', filename='logo/logo.svg') }}" class="h-12 sm:h-16" alt="Logo">
  </div>

  <div class="max-w-2xl mx-auto mb-6">
    <div class="bg-white/10 backdrop-blur-xl border border-white/20 shadow-xl rounded-2xl p-4 sm:p-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
      <div>
        <h1 class="text-xl sm:text-2xl font-bold text-slate-800 break-words">Welcome, {{ current_user.name or 'Unnamed' }}</h1>
        <p class="text-xs text-slate-600 mt-1 bg-white/20 rounded-lg px-3 py-2 border border-white/10">
          üõ†Ô∏è Tip: To activate your machine, scan the Master QR code that came with your shipment.
        </p>
      </div>
      <div class="flex gap-3 flex-wrap justify-center sm:justify-end">
        <a href="{{ url_for('routes.create_subuser') }}" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-xl text-sm shadow-md">Manage Sub-User</a>
        <a href="{{ url_for('routes.user_settings') }}" class="bg-white/30 border border-white/20 backdrop-blur-md text-sm px-4 py-2 rounded-xl text-blue-700 hover:text-blue-900 shadow-md">Settings</a>
        <a href="{{ url_for('routes.logout') }}" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-xl shadow-md text-sm">Logout</a>
      </div>
    </div>
  </div>

  {% set machine_count = batches | selectattr('machine') | list | length %}
  {% set batch_count = batches | length %}

  <!-- Stats Grid -->
  <div class="max-w-2xl mx-auto grid grid-cols-2 gap-4 mb-6">
    <!-- Machines -->
    <div onclick="toggleMachineDashboard()" id="machines-box"
         class="cursor-pointer bg-green-50 text-green-700 border-green-400 border rounded-2xl shadow-md p-4 flex flex-col items-center transition-all duration-500 ease-in-out hover:scale-[1.01] col-span-1">
      <img src="{{ url_for('static', filename='emb assets/machine.png') }}" class="h-10 w-10 mb-2" alt="Machine Icon" />
      <p class="font-semibold text-sm">Total Machines</p>
      <p class="text-2xl font-bold text-black">{{ machine_count }}</p>
      <p class="text-xs text-slate-600 mt-1">Click to view details</p>
    </div>

    <!-- Batches -->
    <div id="batches-box" class="bg-green-50 text-green-700 border-green-400 border rounded-2xl shadow-md p-4 flex flex-col items-center">
      <img src="{{ url_for('static', filename='emb assets/batch.png') }}" class="h-10 w-10 mb-2" alt="Batch Icon" />
      <p class="font-semibold text-sm">Claimed Batches</p>
      <p class="text-2xl font-bold text-black">{{ batch_count }}</p>
    </div>
  </div>

  <!-- Machine Dashboard Expanded View -->
  <div id="machine-dashboard" class="hidden max-w-2xl mx-auto mt-4">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-2xl font-bold text-slate-800">üñ• Machine Dashboard</h2>
      <button onclick="closeMachineDashboard()" class="text-blue-600 text-sm underline">‚Üê Back</button>
    </div>

    {% for data in machines_data %}
    <div id="machine-{{ data.machine.id }}" class="mb-6 bg-white rounded-xl shadow-md p-4 border border-gray-200">

      <div class="bg-gray-50 p-3 rounded-md mb-3">
        <h3 class="text-lg font-semibold mb-2">üß© Machine Overview</h3>
        <ul class="text-sm text-gray-700">
          <li><strong>Name:</strong> {{ data.machine.name }}</li>
          <li><strong>Type:</strong> {{ data.machine.type }}</li>
          <li><strong>Batch ID:</strong> {{ data.batch.id }}</li>
          <li><strong>Claimed On:</strong> {{ data.batch.created_at.date() }}</li>
          <li><strong>Total Heads:</strong> {{ data.grouped_logs|length }}</li>
          <li><strong>Total Needle Changes:</strong> {{ data.total_needle_changes }}</li>
          <li><strong>Total Services Logged:</strong> {{ data.total_services_logged }}</li>
        </ul>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
        <div class="bg-green-100 p-3 rounded-md">
          <h4 class="font-medium mb-1">ü™° Last Needle Change</h4>
          {% if data.last_needle %}
            <p><strong>Date:</strong> {{ data.last_needle.timestamp.date() }}</p>
            <p><strong>Head:</strong> {{ data.last_needle.sub_tag.tag_type }}</p>
            <p><strong>Needle #:</strong> {{ data.last_needle.needle_number }}</p>
            <p><strong>Type:</strong> {{ data.last_needle.needle_type }}</p>
          {% else %}
            <p class="italic text-gray-500">No needle changes.</p>
          {% endif %}
        </div>
        <div class="bg-yellow-100 p-3 rounded-md">
          <h4 class="font-medium mb-1">üîß Last Service Log</h4>
          {% if data.last_service %}
            <p><strong>Part:</strong> {{ data.last_service.part_name }}</p>
            <p><strong>Description:</strong> {{ data.last_service.description }}</p>
            <p><strong>Warranty Till:</strong> {{ data.last_service.warranty_till }}</p>
            <p><strong>Logged On:</strong> {{ data.last_service.timestamp.date() }}</p>
          {% else %}
            <p class="italic text-gray-500">No service logs.</p>
          {% endif %}
        </div>
      </div>

      <div class="p-3 rounded-md {% if data.maintenance_ok %}bg-green-50{% else %}bg-red-50{% endif %}">
        <h4 class="font-semibold text-sm mb-2">üõ†Ô∏è Maintenance Status</h4>
        {% if data.maintenance_ok %}
          <p class="text-green-800">‚úÖ All good.</p>
        {% else %}
          <ul class="list-disc list-inside text-red-700 text-sm">
            {% if data.warranty_warning %}
              <li>‚ö†Ô∏è Warranty expiring soon.</li>
            {% endif %}
            {% if data.stale_service_warning %}
              <li>‚ö†Ô∏è No service in 60+ days.</li>
            {% endif %}
          </ul>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>

</body>
</html>
