<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>User Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    function toggleMachineDashboard() {
      document.getElementById("machines-box").classList.toggle("col-span-2");
      document.getElementById("batches-box").classList.toggle("hidden");
      document.getElementById("machine-dashboard").classList.toggle("hidden");
    }

    function closeMachineDashboard() {
      toggleMachineDashboard();
    }

    function toggleLogs(id) {
      document.getElementById(`logs-${id}`).classList.toggle("hidden");
      document.getElementById(`log-arrow-${id}`).classList.toggle("rotate-180");
    }

    function toggleWarrantyDetails(id) {
      document.getElementById(`warranty-detail-${id}`).classList.toggle("hidden");
    }

    window.addEventListener("DOMContentLoaded", () => {
      const toast = document.getElementById("login-toast");
      if (toast) {
        toast.classList.remove("opacity-0", "translate-y-6");
        toast.classList.add("opacity-100", "translate-y-0");

        setTimeout(() => {
          toast.classList.add("opacity-0", "translate-y-6");
          toast.classList.remove("opacity-100", "translate-y-0");
        }, 3000);
      }
    });
  </script>
</head>
<body class="bg-gradient-to-br from-blue-100 to-white min-h-screen text-gray-800 p-2">

  {% if show_toast %}
<div id="login-toast" class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-green-100 border border-green-300 text-green-700 px-8 py-6 rounded-xl shadow-xl flex flex-col items-center z-50 opacity-0 transition-opacity duration-500">
  <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-green-500 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
    <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
  </svg>
  <p class="text-lg font-medium">Login successful</p>
</div>

<script>
  window.addEventListener("DOMContentLoaded", () => {
    const toast = document.getElementById("login-toast");
    toast.classList.remove("opacity-0");
    setTimeout(() => {
      toast.classList.add("opacity-0");
    }, 3000); // hide after 3 seconds
  });
</script>
{% endif %}


  <!-- Logo -->
  <div class="max-w-2xl mx-auto mb-2">
    <div class="flex justify-start items-center">
      <img src="{{ url_for('static', filename='logo/logo.svg') }}" class="h-16 sm:h-24" alt="Logo">
    </div>
  </div>

  <!-- Welcome Box -->
  <div class="max-w-2xl mx-auto mb-6">
    <div class="bg-white/10 backdrop-blur-xl border border-white/20 shadow-xl rounded-2xl p-4 sm:p-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
      <div>
        <h1 class="text-xl sm:text-2xl font-bold text-slate-800 break-words">Welcome, {{ current_user.name or 'Unnamed' }}</h1>
        <p class="text-xs text-slate-600 mt-1 bg-white/20 rounded-lg px-3 py-2 border border-white/10">
          üõ†Ô∏è Tip: To activate your machine, scan the Master QR code that came with your shipment.
        </p>
      </div>
      <div class="flex gap-3 flex-wrap justify-center sm:justify-end">
        <a href="{{ url_for('routes.create_subuser') }}" class="bg-white/30 border border-white/20 backdrop-blur-md text-sm px-4 py-2 rounded-xl text-blue-700 hover:text-blue-900 shadow-md">Manage Sub-User</a>
        <a href="{{ url_for('routes.user_settings') }}" class="bg-white/30 border border-white/20 backdrop-blur-md text-sm px-4 py-2 rounded-xl text-blue-700 hover:text-blue-900 shadow-md">Settings</a>
        <a href="{{ url_for('routes.logout') }}" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-xl shadow-md text-sm">Logout</a>
      </div>
    </div>
  </div>

  <!-- Counts -->
  {% set machine_count = batches | selectattr('machine') | list | length %}
  {% set batch_count = batches | length %}

  <div class="max-w-2xl mx-auto grid grid-cols-2 gap-4 mb-6">
    <div onclick="toggleMachineDashboard()" id="machines-box"
         class="cursor-pointer bg-green-50 text-green-700 border-green-400 border rounded-2xl shadow-md p-4 flex flex-col items-center transition-all duration-500 ease-in-out hover:scale-[1.01] col-span-1">
      <img src="{{ url_for('static', filename='emb assets/machine.png') }}" class="h-10 w-10 mb-2" alt="Machine Icon" />
      <p class="font-semibold text-sm">Total Machines</p>
      <p class="text-2xl font-bold text-black">{{ machine_count }}</p>
      <p class="text-xs text-slate-600 mt-1">Click to view dashboard</p>
    </div>

    <div id="batches-box" class="bg-green-50 text-green-700 border-green-400 border rounded-2xl shadow-md p-4 flex flex-col items-center">
      <img src="{{ url_for('static', filename='emb assets/batch.png') }}" class="h-10 w-10 mb-2" alt="Batch Icon" />
      <p class="font-semibold text-sm">Claimed Batches</p>
      <p class="text-2xl font-bold text-black">{{ batch_count }}</p>
    </div>
  </div>

  <!-- Machine Dashboard Section -->
  <div id="machine-dashboard" class="hidden max-w-2xl mx-auto mt-4">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-2xl font-bold text-slate-800">Machine Dashboard</h2>
      <button onclick="closeMachineDashboard()" class="text-blue-600 text-sm underline">‚Üê Back</button>
    </div>

    {% for data in machines_data %}
    <!-- Each Machine Block -->
    <div class="mb-14 bg-white rounded-xl shadow-xl p-6 border border-gray-200">
      <div class="bg-gray-50 p-4 rounded-md shadow-sm mb-4">
        <h2 class="text-xl font-semibold mb-3">{{ data.machine.name }}</h2>
        <ul class="space-y-1 text-gray-700">
          <li><strong>Type:</strong> {{ data.machine.type }}</li>
          <li><strong>Batch ID:</strong> {{ data.batch.id }}</li>
          <li><strong>Claimed On:</strong> {{ data.batch.created_at.date() }}</li>
          <li><strong>Assigned Sub-Users:</strong>
            {% if data.subusers %}
              <span class="bg-blue-50 text-blue-700 text-xs font-medium px-2 py-1 rounded-md">
                {% for sub in data.subusers %}
                  {{ sub.name }} ‚Äì {{ sub.static_id }}{% if not loop.last %}, {% endif %}
                {% endfor %}
              </span>
            {% else %}
              <span class="italic text-gray-500">N/A</span>
            {% endif %}
          </li>
          <li><strong>Total Heads:</strong> {{ data.grouped_logs|length }}</li>
          <li><strong>Total Needle Changes:</strong> {{ data.total_needle_changes }}</li>
          <li><strong>Total Services Logged:</strong> {{ data.total_services_logged }}</li>
        </ul>

        <!-- QR Button -->
        <div class="flex justify-end mt-3">
          <button onclick="document.getElementById('qr-{{ data.machine.id }}').classList.toggle('hidden')"
                  class="flex items-center gap-1 px-3 py-1 bg-white/80 hover:bg-white border border-gray-300 rounded-full text-xs text-blue-700 shadow-sm transition">
            <img src="{{ url_for('static', filename='emb assets/qr.png') }}" class="w-4 h-4" alt="QR Icon">
            View QR Codes
          </button>
        </div>

        <!-- QR Section -->
        <div id="qr-{{ data.machine.id }}" class="hidden mt-3">
          <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
            {% for qr in data.qr_codes %}
            <div class="bg-white border rounded-xl p-3 text-center shadow">
              <img src="{{ qr.image_url }}" class="h-24 mx-auto mb-2" alt="QR">
              <p class="capitalize font-medium text-sm">{{ qr.qr_type }}</p>
              <a href="{{ qr.image_url }}" download="{{ qr.qr_type }}.png"
                 class="mt-2 inline-block text-xs bg-blue-600 text-white px-3 py-1 rounded-md hover:bg-blue-700 transition">Download</a>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>

      <!-- Last Activity Boxes -->
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
        <div class="bg-green-50 p-4 rounded-md shadow-sm">
          <h3 class="font-semibold mb-2">ü™° Last Needle Change</h3>
          {% if data.last_needle %}
            <p><strong>Date:</strong> {{ data.last_needle.timestamp.date() }}</p>
            <p><strong>Head:</strong> {{ data.last_needle.sub_tag.tag_type }}</p>
            <p><strong>Needle #:</strong> {{ data.last_needle.needle_number }}</p>
            <p><strong>Type:</strong> {{ data.last_needle.needle_type }}</p>
          {% else %}
            <p class="italic text-gray-500">No needle changes recorded.</p>
          {% endif %}
        </div>

        <div class="bg-yellow-50 p-4 rounded-md shadow-sm">
          <h3 class="font-semibold mb-2">üîß Last Service Log</h3>
          {% if data.last_service %}
            <p><strong>Part:</strong> {{ data.last_service.part_name }}</p>
            <p><strong>Description:</strong> {{ data.last_service.description }}</p>
            <p><strong>Warranty Till:</strong> {{ data.last_service.warranty_till }}</p>
            <p><strong>Logged On:</strong> {{ data.last_service.timestamp.date() }}</p>
          {% else %}
            <p class="italic text-gray-500">No service logs recorded.</p>
          {% endif %}
        </div>
      </div>

      <!-- Maintenance Status -->
      <div class="p-4 rounded-md shadow-sm {% if data.maintenance_ok %}bg-green-100{% else %}bg-red-100{% endif %} mb-4">
        <h3 class="text-lg font-semibold mb-2">üõ†Ô∏è Maintenance Status</h3>
        {% if data.maintenance_ok %}
          <p class="text-green-800">‚úÖ All good. No upcoming warranty or service issues.</p>
        {% else %}
          <ul class="list-disc list-inside text-red-700">
            {% if data.warranty_warning %}
              <li>
                ‚ö†Ô∏è Warranty is expiring soon.
                <button onclick="toggleWarrantyDetails({{ data.machine.id }})" class="ml-2 text-xs underline text-blue-800">(View Details)</button>
              </li>
              <ul id="warranty-detail-{{ data.machine.id }}" class="hidden ml-6 mt-2 text-sm text-red-700 list-disc">
                {% for head_id, group in data.grouped_logs.items() %}
                  {% for log in group.service_logs %}
                    {% if log.warranty_till and log.warranty_till <= (now + timedelta(days=30)).date() %}
                      <li>{{ log.part_name }} (Head: {{ group.tag.tag_type }}) ‚Äì Warranty till {{ log.warranty_till }}</li>
                    {% endif %}
                  {% endfor %}
                {% endfor %}
              </ul>
            {% endif %}
            {% if data.stale_service_warning %}
              <li>‚ö†Ô∏è No service logged in the past 60 days.</li>
            {% endif %}
          </ul>
        {% endif %}
      </div>

      <!-- View Logs Toggle -->
      <div class="flex justify-start mt-4">
        <button onclick="toggleLogs({{ data.machine.id }})"
          class="flex items-center gap-2 text-sm px-4 py-2 bg-white hover:bg-blue-50 text-blue-700 border border-blue-200 rounded-lg shadow-sm transition">
          <img src="{{ url_for('static', filename='emb assets/qr2.png') }}" class="w-4 h-4" alt="QR Icon">
          Head-wise Log View
          <svg id="log-arrow-{{ data.machine.id }}" class="w-4 h-4 transition-transform duration-300" fill="none" stroke="currentColor" stroke-width="2"
               viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
        </button>
      </div>

      <div id="logs-{{ data.machine.id }}" class="hidden mt-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          {% for head_id, group in data.grouped_logs.items() %}
          <div class="bg-gray-50 border border-gray-200 rounded-md p-4 shadow-sm">
            <h4 class="font-semibold text-gray-800 mb-2">üîπ Head: {{ group.tag.tag_type }}</h4>

            {% if group.needle_logs %}
            <div class="mb-3">
              <strong>ü™° Needle Logs:</strong>
              <ul class="list-disc list-inside text-sm ml-4">
                {% for log in group.needle_logs %}
                <li>{{ log.timestamp.date() }} ‚Äì Needle #{{ log.needle_number }}, Type {{ log.needle_type }}</li>
                {% endfor %}
              </ul>
            </div>
            {% else %}
            <p class="italic text-gray-500 text-sm mb-3">‚ùå No needle logs</p>
            {% endif %}

            {% if group.service_logs %}
            <div>
              <strong>üîß Service Logs:</strong>
              <ul class="list-disc list-inside text-sm ml-4">
                {% for log in group.service_logs %}
                <li>{{ log.timestamp.date() }} ‚Äì {{ log.part_name }} ({{ log.description }}) ‚Äì Warranty till {{ log.warranty_till }}</li>
                {% endfor %}
              </ul>
            </div>
            {% else %}
            <p class="italic text-gray-500 text-sm">‚ùå No service logs</p>
            {% endif %}
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

</body>
</html>
