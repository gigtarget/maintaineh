<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>User Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    function toggleMachineDashboard() {
      document.getElementById("machines-box").classList.toggle("col-span-2");
      document.getElementById("batches-box").classList.toggle("hidden");
      document.getElementById("machine-dashboard").classList.toggle("hidden");
    }

    function closeMachineDashboard() {
      toggleMachineDashboard();
    }

    function toggleLogs(id) {
      document.getElementById(`logs-${id}`).classList.toggle("hidden");
      document.getElementById(`log-arrow-${id}`).classList.toggle("rotate-180");
    }

    function toggleWarrantyDetails(id) {
      document.getElementById(`warranty-detail-${id}`).classList.toggle("hidden");
    }

    function toggleRequests(idx) {
      document.getElementById(`requests-${idx}`).classList.toggle("hidden");
    }

    window.addEventListener("DOMContentLoaded", () => {
      const toast = document.getElementById("login-toast");
      if (toast) {
        toast.classList.remove("opacity-0", "translate-y-6");
        toast.classList.add("opacity-100", "translate-y-0");
        setTimeout(() => {
          toast.classList.add("opacity-0", "translate-y-6");
          toast.classList.remove("opacity-100", "translate-y-0");
        }, 1000);
      }
    });
  </script>
</head>
<body class="bg-gradient-to-br from-blue-100 to-white min-h-screen text-gray-800 p-2">

{% if show_toast %}
  <div id="login-toast" class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-green-100 border border-green-300 text-green-700 px-6 py-4 rounded-lg shadow-lg flex flex-col items-center z-50 opacity-0 transition-opacity duration-300">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-500 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
    </svg>
    <p class="text-sm font-medium">Login successful</p>
  </div>
{% endif %}

<!-- Logo + Welcome -->
<div class="max-w-2xl mx-auto mb-2">
  <div class="flex justify-start items-center">
    <img src="{{ url_for('static', filename='logo/logo.svg') }}" class="h-16 sm:h-24" alt="Logo">
  </div>
</div>

<!-- Header Buttons -->
<div class="max-w-2xl mx-auto mb-6">
  <div class="bg-white/10 backdrop-blur-xl border border-white/20 shadow-xl rounded-2xl p-4 sm:p-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
    <div>
      <h1 class="text-xl sm:text-2xl font-bold text-slate-800 break-words">Welcome, {{ current_user.name or 'Unnamed' }}</h1>
      <p class="text-xs text-slate-600 mt-1 bg-white/20 rounded-lg px-3 py-2 border border-white/10">
        üõ†Ô∏è Tip: To activate your machine, scan the Master QR code that came with your shipment.
      </p>
    </div>
    <div class="flex gap-3 flex-wrap justify-center sm:justify-end">
      <a href="{{ url_for('routes.create_subuser') }}" class="bg-white/30 border border-white/20 backdrop-blur-md text-sm px-4 py-2 rounded-xl text-blue-700 hover:text-blue-900 shadow-md">Manage Sub-User</a>
      <a href="{{ url_for('routes.user_settings') }}" class="bg-white/30 border border-white/20 backdrop-blur-md text-sm px-4 py-2 rounded-xl text-blue-700 hover:text-blue-900 shadow-md">Settings</a>
      <a href="{{ url_for('routes.logout') }}" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-xl shadow-md text-sm">Logout</a>
    </div>
  </div>
</div>

<!-- Machine & Batch Count Cards -->
{% set machine_count = batches | selectattr('machine') | list | length %}
{% set batch_count = batches | length %}
<div class="max-w-2xl mx-auto grid grid-cols-2 gap-4 mb-6">
  <div onclick="toggleMachineDashboard()" id="machines-box" class="cursor-pointer bg-green-50 text-green-700 border-green-400 border rounded-2xl shadow-md p-4 flex flex-col items-center hover:scale-[1.01] col-span-1 transition-all duration-500 ease-in-out">
    <img src="{{ url_for('static', filename='emb assets/machine.png') }}" class="h-10 w-10 mb-2" alt="Machine Icon" />
    <p class="font-semibold text-sm">Total Machines</p>
    <p class="text-2xl font-bold text-black">{{ machine_count }}</p>
    <p class="text-xs text-slate-600 mt-1">Click to view dashboard</p>
  </div>
  <div id="batches-box" class="bg-green-50 text-green-700 border-green-400 border rounded-2xl shadow-md p-4 flex flex-col items-center">
    <img src="{{ url_for('static', filename='emb assets/batch.png') }}" class="h-10 w-10 mb-2" alt="Batch Icon" />
    <p class="font-semibold text-sm">Claimed Batches</p>
    <p class="text-2xl font-bold text-black">{{ batch_count }}</p>
  </div>
</div>

<!-- Machine Dashboard Section -->
<div id="machine-dashboard" class="max-w-4xl mx-auto hidden">
  <div class="flex justify-between items-center mb-3">
    <h2 class="text-xl font-bold text-slate-800">üß∞ Machine Dashboard</h2>
    <button onclick="closeMachineDashboard()" class="text-sm text-blue-600 hover:text-blue-800 underline">Close</button>
  </div>

  {% for machine in quick_overview %}
    <div class="bg-white border border-slate-200 shadow-sm rounded-2xl mb-6">
      <div class="px-4 py-3 flex justify-between items-center">
        <div>
          <h3 class="font-bold text-lg text-slate-800">{{ machine.name }}</h3>
          {% if machine.assigned_subuser %}
            <p class="text-xs text-slate-500 mt-1">Assigned to: {{ machine.assigned_subuser }}</p>
          {% endif %}
        </div>
        <div class="flex items-center space-x-2">
          <!-- Oiled Today -->
          <div class="flex flex-col items-center">
            <span class="text-xl">{{ '‚úÖ' if machine.oiled_today else '‚ùå' }}</span>
            <span class="text-xs text-slate-500">Oiled</span>
          </div>
          <!-- Weekly Lube -->
          <div class="flex flex-col items-center">
            <span class="text-xl">{{ '‚úÖ' if machine.weekly_lube_done else '‚ùå' }}</span>
            <span class="text-xs text-slate-500">Lube</span>
          </div>
          <!-- Status OK -->
          <div class="flex flex-col items-center">
            <span class="text-xl">{{ 'üü¢' if machine.status_ok else 'üî¥' }}</span>
            <span class="text-xs text-slate-500">Status</span>
          </div>
          <!-- Service Requests -->
          <div class="flex flex-col items-center cursor-pointer" onclick="toggleRequests({{ loop.index }})">
            <span class="text-xl">üì©</span>
            <span class="text-xs font-medium text-slate-600 underline">{{ machine.pending_count }} pending</span>
            <span class="text-[10px] text-blue-500 mt-0.5">Click to view</span>
          </div>
        </div>
      </div>

      <!-- Service Request Detail -->
      <div id="requests-{{ loop.index }}" class="hidden px-4 pb-4 pt-2">
        {% if machine.pending_requests %}
          <div class="space-y-3">
            {% for req in machine.pending_requests %}
              <div class="bg-slate-50 border border-slate-200 p-3 rounded-lg shadow-sm">
                <p class="text-sm"><span class="font-semibold">From:</span> {{ req.subuser_name or "Unknown" }}</p>
                <p class="text-sm"><span class="font-semibold">Heads:</span> {{ req.heads or 'N/A' }}</p>
                <p class="text-sm"><span class="font-semibold">Issue:</span> {{ req.message or req.issue or "N/A" }}</p>
                <p class="text-xs text-slate-500">Date: {{ req.timestamp.strftime('%d %b %Y') }}</p>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="text-sm text-slate-600">No service requests found for this machine.</p>
        {% endif %}
      </div>
    </div>
  {% endfor %}
</div>

<!-- Quick Machine Overview -->
{% if quick_overview %}
<div class="max-w-6xl mx-auto mt-10 px-4">
  <h2 class="text-xl font-bold text-slate-800 mb-4 text-center">Quick Machine Overview</h2>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    {% for m in quick_overview %}
      <div class="rounded-xl bg-white border border-slate-300 p-4 shadow-sm relative">
        <div class="absolute top-3 right-3 w-3 h-3 rounded-full {% if m.status_ok %}bg-green-500{% else %}bg-red-500{% endif %}"></div>
        <h3 class="font-semibold text-lg text-slate-900">{{ m.name }}</h3>
        <p class="text-sm text-slate-600">Assigned to: {{ m.assigned_subuser or "Not Assigned" }}</p>
        <p class="mt-2 text-sm">
          <strong>Oiled Today:</strong> {{ "Yes" if m.oiled_today else "No" }}
        </p>
        <p class="text-sm">
          <strong>Service Requests:</strong>
          <span class="text-blue-600 font-semibold cursor-pointer" onclick="toggleRequests({{ loop.index }})">
            {{ m.pending_count }} pending (Click to view)
          </span>
        </p>
        <p class="text-sm">
          <strong>Weekly Lube:</strong>
          {% if m.weekly_lube_done %}
            <span class="text-green-600">Done</span>
          {% else %}
            <span class="text-red-600">Not Done</span>
          {% endif %}
        </p>

        <!-- Expandable Request List -->
        <div id="requests-{{ loop.index }}" class="mt-3 hidden">
          {% for req in m.pending_requests %}
            <div class="mt-2 p-3 bg-slate-50 border rounded">
              <p><strong>From:</strong> {{ req.subuser_name or 'Unknown' }}</p>
              <p><strong>Heads:</strong> {{ req.heads or 'None' }}</p>
              <p><strong>Issue:</strong> {{ req.message or 'Not specified' }}</p>
              <p class="text-xs text-slate-500">{{ req.timestamp.strftime('%Y-%m-%d %I:%M %p') }}</p>
              <form method="POST" action="/resolve_service/{{ req.id }}">
                <button class="mt-2 text-xs bg-green-500 text-white px-2 py-1 rounded shadow">Mark Resolved</button>
              </form>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endfor %}
  </div>
</div>
<script>
  function toggleRequests(index) {
    const section = document.getElementById(`requests-${index}`);
    section.classList.toggle("hidden");
  }
</script>
{% endif %}


<!-- Footer -->
<div class="max-w-4xl mx-auto text-center mt-12 mb-6 text-xs text-slate-500">
  Built with ‚ù§Ô∏è by Tokatap ¬∑ {{ now.strftime('%B %d, %Y') }}
</div>

</body>
</html>


